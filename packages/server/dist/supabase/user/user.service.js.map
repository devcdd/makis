{"version":3,"sources":["../../../src/supabase/user/user.service.ts"],"sourcesContent":["import { Injectable } from '@nestjs/common';\nimport { SupabaseService } from '../supabase.service';\nimport { User, Character, CreateCharacterRequest, Provider } from '../../types';\nimport { MESSAGES, ERROR_LOG_PREFIX } from '../../constants/messages';\n\n@Injectable()\nexport class UserService {\n  constructor(private supabaseService: SupabaseService) {}\n\n  // ===== USERS 테이블 관련 메소드 =====\n\n  async saveUser(userData: User): Promise<User[]> {\n    // SUPABASE 환경변수 디버깅 출력\n    console.log('=== SUPABASE 환경변수 확인 ===');\n    console.log('SUPABASE_URL:', process.env.SUPABASE_URL);\n    console.log('SUPABASE_ANON_KEY 존재:', !!process.env.SUPABASE_ANON_KEY);\n    console.log(\n      'SUPABASE_ANON_KEY 길이:',\n      process.env.SUPABASE_ANON_KEY?.length,\n    );\n    console.log('=== 사용자 데이터 ===');\n    console.log('userData:', JSON.stringify(userData, null, 2));\n\n    const { data, error } = await this.supabaseService\n      .getClient()\n      .from('users')\n      .insert([userData])\n      .select();\n\n    if (error) {\n      console.error(ERROR_LOG_PREFIX.SUPABASE_ERROR_DETAILS, {\n        message: error.message,\n        code: error.code,\n        details: error.details,\n        hint: error.hint,\n      });\n\n      if (error.code === '23505') {\n        throw new Error(MESSAGES.DUPLICATE_USER_ID);\n      }\n\n      throw error;\n    }\n\n    return data as User[];\n  }\n\n  async getUserByUserId(userId: string): Promise<User | null> {\n    console.log('=== getUserByUserId 호출 ===');\n    console.log('조회할 userId:', userId);\n\n    const client = this.supabaseService.getClient();\n    console.log('Supabase 클라이언트 URL:', (client as any).supabaseUrl);\n\n    const { data, error } = await client\n      .from('users')\n      .select('*')\n      .eq('userId', userId)\n      .single();\n\n    if (error) {\n      console.log('supabase error:', error);\n\n      // PGRST116: 데이터가 없는 경우 - 유저 생성\n      if (error.code === 'PGRST116') {\n        console.log('유저를 찾을 수 없음. 새로운 유저 생성:', userId);\n        const createdUsers = await this.saveUser({\n          userId,\n          provider: Provider.KAKAO,\n        });\n        console.log('유저 생성 완료:', userId);\n        return createdUsers[0];\n      }\n\n      // 다른 에러인 경우 throw\n      console.error('유저 조회 중 에러 발생:', error);\n      throw error;\n    }\n\n    // 데이터가 있는 경우\n    console.log('유저 조회 성공:', userId);\n    return data as User;\n  }\n\n  async isUserAdmin(userId: string): Promise<boolean> {\n    console.log('=== isUserAdmin 호출 ===');\n    console.log('관리자 권한 확인할 userId:', userId);\n\n    try {\n      const { data, error } = await this.supabaseService\n        .getClient()\n        .from('users')\n        .select('isAdmin')\n        .eq('userId', userId)\n        .single();\n\n      if (error) {\n        console.error('관리자 권한 조회 실패:', {\n          message: error.message,\n          code: error.code,\n          details: error.details,\n          hint: error.hint,\n        });\n        return false; // 에러 발생시 기본적으로 false 반환\n      }\n\n      const isAdmin = data?.isAdmin === true;\n      console.log(`사용자 ${userId} 관리자 권한:`, isAdmin);\n      return isAdmin;\n    } catch (error) {\n      console.error('관리자 권한 확인 중 예외 발생:', error);\n      return false; // 예외 발생시 기본적으로 false 반환\n    }\n  }\n\n  async updateUserNickname(userId: string, nickname: string): Promise<User> {\n    console.log('=== updateUserNickname 호출 ===');\n    console.log('userId:', userId, 'nickname:', nickname);\n\n    const { data, error } = await this.supabaseService\n      .getClient()\n      .from('users')\n      .update({ nickname })\n      .eq('userId', userId)\n      .select()\n      .single();\n\n    if (error) {\n      console.error(ERROR_LOG_PREFIX.SUPABASE_ERROR_DETAILS, {\n        message: error.message,\n        code: error.code,\n        details: error.details,\n        hint: error.hint,\n      });\n      throw error;\n    }\n\n    console.log('닉네임 업데이트 성공:', userId, nickname);\n    return data as User;\n  }\n\n  // ===== CHARACTERS 테이블 관련 메소드 =====\n\n  async saveCharacter(\n    characterData: CreateCharacterRequest,\n  ): Promise<{ success: boolean; message: string; data?: Character[] }> {\n    const { data, error } = await this.supabaseService\n      .getClient()\n      .from('characters')\n      .insert([\n        {\n          characterId: characterData.characterId,\n          ownerId: characterData.ownerId,\n        },\n      ])\n      .select();\n\n    if (error) {\n      console.error(ERROR_LOG_PREFIX.SUPABASE_ERROR_DETAILS, {\n        message: error.message,\n        code: error.code,\n        details: error.details,\n        hint: error.hint,\n      });\n\n      if (error.code === '23505') {\n        throw new Error(MESSAGES.DUPLICATE_CHARACTER_ID);\n      }\n\n      throw error;\n    }\n\n    return {\n      success: true,\n      message: MESSAGES.CREATE_CHARACTER_SUCCESS,\n      data: data as Character[],\n    };\n  }\n\n  async getAllCharacters(): Promise<Character[]> {\n    const { data, error } = await this.supabaseService\n      .getClient()\n      .from('characters')\n      .select('*');\n\n    if (error) {\n      console.error(ERROR_LOG_PREFIX.SUPABASE_ERROR_DETAILS, {\n        message: error.message,\n        code: error.code,\n        details: error.details,\n        hint: error.hint,\n      });\n      throw error;\n    }\n\n    return data as Character[];\n  }\n}\n"],"names":["UserService","saveUser","userData","console","log","process","env","SUPABASE_URL","SUPABASE_ANON_KEY","length","JSON","stringify","data","error","supabaseService","getClient","from","insert","select","ERROR_LOG_PREFIX","SUPABASE_ERROR_DETAILS","message","code","details","hint","Error","MESSAGES","DUPLICATE_USER_ID","getUserByUserId","userId","client","supabaseUrl","eq","single","createdUsers","provider","Provider","KAKAO","isUserAdmin","isAdmin","updateUserNickname","nickname","update","saveCharacter","characterData","characterId","ownerId","DUPLICATE_CHARACTER_ID","success","CREATE_CHARACTER_SUCCESS","getAllCharacters"],"mappings":"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"}