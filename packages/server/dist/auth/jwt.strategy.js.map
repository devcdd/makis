{"version":3,"sources":["../../src/auth/jwt.strategy.ts"],"sourcesContent":["import { Injectable, UnauthorizedException } from '@nestjs/common';\nimport { PassportStrategy } from '@nestjs/passport';\nimport { ExtractJwt, Strategy } from 'passport-jwt';\nimport { ConfigService } from '@nestjs/config';\nimport { UserService } from '../supabase/user';\nimport { JwtPayload } from '../types';\n\n@Injectable()\nexport class JwtStrategy extends PassportStrategy(Strategy) {\n  constructor(\n    private readonly userService: UserService,\n    private readonly configService: ConfigService,\n  ) {\n    super({\n      jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),\n      ignoreExpiration: false,\n      secretOrKey:\n        configService.get<string>('JWT_SECRET') || 'default-secret-key',\n    });\n  }\n\n  async validate(payload: JwtPayload): Promise<any> {\n    try {\n      console.log('üîê JWT Strategy validate Ìò∏Ï∂ú:', {\n        userId: payload.userId,\n        iat: payload.iat,\n        exp: payload.exp,\n        currentTime: Math.floor(Date.now() / 1000),\n        remainingTime: payload.exp\n          ? payload.exp - Math.floor(Date.now() / 1000)\n          : 'unknown',\n      });\n\n      const user = await this.userService.getUserByUserId(payload.userId);\n\n      if (!user) {\n        console.log('‚ùå JWT Strategy: ÏÇ¨Ïö©ÏûêÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå -', payload.userId);\n        throw new UnauthorizedException('ÏÇ¨Ïö©ÏûêÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');\n      }\n\n      console.log('‚úÖ JWT Strategy: ÌÜ†ÌÅ∞ Í≤ÄÏ¶ù ÏÑ±Í≥µ -', payload.userId);\n      return {\n        userId: user.userId,\n        provider: user.provider,\n        nickname: user.nickname,\n        isAdmin: await this.userService.isUserAdmin(user.userId),\n      };\n    } catch (error) {\n      const errorMessage =\n        error instanceof Error ? error.message : 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò';\n      console.log('‚ùå JWT Strategy: ÌÜ†ÌÅ∞ Í≤ÄÏ¶ù Ïã§Ìå® -', errorMessage);\n      throw new UnauthorizedException('ÌÜ†ÌÅ∞ Í≤ÄÏ¶ùÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');\n    }\n  }\n}\n"],"names":["JwtStrategy","PassportStrategy","Strategy","validate","payload","console","log","userId","iat","exp","currentTime","Math","floor","Date","now","remainingTime","user","userService","getUserByUserId","UnauthorizedException","provider","nickname","isAdmin","isUserAdmin","error","errorMessage","Error","message","configService","jwtFromRequest","ExtractJwt","fromAuthHeaderAsBearerToken","ignoreExpiration","secretOrKey","get"],"mappings":";;;;+BAQaA;;;eAAAA;;;wBARqC;0BACjB;6BACI;wBACP;sBACF;;;;;;;;;;AAIrB,IAAA,AAAMA,cAAN,MAAMA,oBAAoBC,IAAAA,0BAAgB,EAACC,qBAAQ;IAaxD,MAAMC,SAASC,OAAmB,EAAgB;QAChD,IAAI;YACFC,QAAQC,GAAG,CAAC,gCAAgC;gBAC1CC,QAAQH,QAAQG,MAAM;gBACtBC,KAAKJ,QAAQI,GAAG;gBAChBC,KAAKL,QAAQK,GAAG;gBAChBC,aAAaC,KAAKC,KAAK,CAACC,KAAKC,GAAG,KAAK;gBACrCC,eAAeX,QAAQK,GAAG,GACtBL,QAAQK,GAAG,GAAGE,KAAKC,KAAK,CAACC,KAAKC,GAAG,KAAK,QACtC;YACN;YAEA,MAAME,OAAO,MAAM,IAAI,CAACC,WAAW,CAACC,eAAe,CAACd,QAAQG,MAAM;YAElE,IAAI,CAACS,MAAM;gBACTX,QAAQC,GAAG,CAAC,kCAAkCF,QAAQG,MAAM;gBAC5D,MAAM,IAAIY,6BAAqB,CAAC;YAClC;YAEAd,QAAQC,GAAG,CAAC,8BAA8BF,QAAQG,MAAM;YACxD,OAAO;gBACLA,QAAQS,KAAKT,MAAM;gBACnBa,UAAUJ,KAAKI,QAAQ;gBACvBC,UAAUL,KAAKK,QAAQ;gBACvBC,SAAS,MAAM,IAAI,CAACL,WAAW,CAACM,WAAW,CAACP,KAAKT,MAAM;YACzD;QACF,EAAE,OAAOiB,OAAO;YACd,MAAMC,eACJD,iBAAiBE,QAAQF,MAAMG,OAAO,GAAG;YAC3CtB,QAAQC,GAAG,CAAC,8BAA8BmB;YAC1C,MAAM,IAAIN,6BAAqB,CAAC;QAClC;IACF;IA5CA,YACE,AAAiBF,WAAwB,EACzC,AAAiBW,aAA4B,CAC7C;QACA,KAAK,CAAC;YACJC,gBAAgBC,uBAAU,CAACC,2BAA2B;YACtDC,kBAAkB;YAClBC,aACEL,cAAcM,GAAG,CAAS,iBAAiB;QAC/C,SARiBjB,cAAAA,kBACAW,gBAAAA;IAQnB;AAmCF"}