{"version":3,"sources":["../../src/auth/admin.guard.ts"],"sourcesContent":["import {\n  Injectable,\n  ExecutionContext,\n  UnauthorizedException,\n  ForbiddenException,\n} from '@nestjs/common';\nimport { JwtService } from '@nestjs/jwt';\nimport { UserService } from '../supabase/user';\n\ninterface JwtPayload {\n  sub: string;\n  userId: string;\n  provider: string;\n  iat?: number;\n  exp?: number;\n}\n\n@Injectable()\nexport class AdminGuard {\n  constructor(\n    private readonly jwtService: JwtService,\n    private readonly userService: UserService,\n  ) {}\n\n  async canActivate(context: ExecutionContext): Promise<boolean> {\n    const request = context.switchToHttp().getRequest();\n    const authHeader = request.headers.authorization;\n\n    if (!authHeader || !authHeader.startsWith('Bearer ')) {\n      throw new UnauthorizedException('ì¸ì¦ í† í°ì´ í•„ìš”í•©ë‹ˆë‹¤.');\n    }\n\n    try {\n      const token = authHeader.substring(7);\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\n      const decoded = this.jwtService.verify(token) as any;\n      const userId = decoded.userId;\n\n      if (!userId) {\n        throw new UnauthorizedException('ìœ íš¨í•˜ì§€ ì•Šì€ í† í°ì…ë‹ˆë‹¤.');\n      }\n\n      console.log(`ğŸ”’ ê´€ë¦¬ì ê¶Œí•œ í™•ì¸ ì‹œì‘ - userId: ${userId}`);\n\n      // ì‚¬ìš©ì ê´€ë¦¬ì ê¶Œí•œ í™•ì¸\n      const isAdmin = await this.userService.isUserAdmin(userId);\n\n      if (!isAdmin) {\n        console.log(`âŒ ê´€ë¦¬ì ê¶Œí•œ ì—†ìŒ - userId: ${userId}`);\n        throw new ForbiddenException('ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');\n      }\n\n      console.log(`âœ… ê´€ë¦¬ì ê¶Œí•œ í™•ì¸ ì™„ë£Œ - userId: ${userId}`);\n\n      // ìš”ì²­ ê°ì²´ì— ì‚¬ìš©ì ì •ë³´ ì¶”ê°€\n      request.user = {\n        userId: userId,\n        isAdmin: true,\n      };\n\n      return true;\n    } catch (error) {\n      if (error instanceof UnauthorizedException || error instanceof ForbiddenException) {\n        throw error;\n      }\n\n      console.error('ê´€ë¦¬ì ê¶Œí•œ í™•ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);\n      throw new UnauthorizedException('ì¸ì¦ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');\n    }\n  }\n}\n"],"names":["AdminGuard","canActivate","context","request","switchToHttp","getRequest","authHeader","headers","authorization","startsWith","UnauthorizedException","token","substring","decoded","jwtService","verify","userId","console","log","isAdmin","userService","isUserAdmin","ForbiddenException","user","error"],"mappings":";;;;+BAkBaA;;;eAAAA;;;wBAbN;qBACoB;sBACC;;;;;;;;;;AAWrB,IAAA,AAAMA,aAAN,MAAMA;IAMX,MAAMC,YAAYC,OAAyB,EAAoB;QAC7D,MAAMC,UAAUD,QAAQE,YAAY,GAAGC,UAAU;QACjD,MAAMC,aAAaH,QAAQI,OAAO,CAACC,aAAa;QAEhD,IAAI,CAACF,cAAc,CAACA,WAAWG,UAAU,CAAC,YAAY;YACpD,MAAM,IAAIC,6BAAqB,CAAC;QAClC;QAEA,IAAI;YACF,MAAMC,QAAQL,WAAWM,SAAS,CAAC;YACnC,8DAA8D;YAC9D,MAAMC,UAAU,IAAI,CAACC,UAAU,CAACC,MAAM,CAACJ;YACvC,MAAMK,SAASH,QAAQG,MAAM;YAE7B,IAAI,CAACA,QAAQ;gBACX,MAAM,IAAIN,6BAAqB,CAAC;YAClC;YAEAO,QAAQC,GAAG,CAAC,CAAC,0BAA0B,EAAEF,QAAQ;YAEjD,gBAAgB;YAChB,MAAMG,UAAU,MAAM,IAAI,CAACC,WAAW,CAACC,WAAW,CAACL;YAEnD,IAAI,CAACG,SAAS;gBACZF,QAAQC,GAAG,CAAC,CAAC,sBAAsB,EAAEF,QAAQ;gBAC7C,MAAM,IAAIM,0BAAkB,CAAC;YAC/B;YAEAL,QAAQC,GAAG,CAAC,CAAC,yBAAyB,EAAEF,QAAQ;YAEhD,mBAAmB;YACnBb,QAAQoB,IAAI,GAAG;gBACbP,QAAQA;gBACRG,SAAS;YACX;YAEA,OAAO;QACT,EAAE,OAAOK,OAAO;YACd,IAAIA,iBAAiBd,6BAAqB,IAAIc,iBAAiBF,0BAAkB,EAAE;gBACjF,MAAME;YACR;YAEAP,QAAQO,KAAK,CAAC,sBAAsBA;YACpC,MAAM,IAAId,6BAAqB,CAAC;QAClC;IACF;IAlDA,YACE,AAAiBI,UAAsB,EACvC,AAAiBM,WAAwB,CACzC;aAFiBN,aAAAA;aACAM,cAAAA;IAChB;AAgDL"}